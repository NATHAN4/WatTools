<html>
	<head>
		<title>wattools editor</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>wattools editor</h1></td><td></td></tr><tr class="filename"><td><h2 id="js/editor.js"><a href="#">editor</a></h2></td><td>js/editor.js</td></tr><tr class="code">
<td class="docs">
<h2>TODO faster templating - convert more things to use mustache?</h2>

<p>enter button submit dialogs
make revisions available to all users
provide explanation of the fact that this is a wiki
make revision deletion possible
reuse dialogs
 </p>
</td>
<td class="code">

</td>
</tr>
<tr class="code">
<td class="docs">
<p>Debug tools - built only if necessary and possible
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">debug</span> = {
  <span class="variable">on</span>: <span class="variable">true</span>,
  <span class="variable">time</span>: <span class="keyword">function</span>(<span class="keyword">label</span>) {
    <span class="keyword">if</span>(<span class="variable">debug</span>.<span class="variable">on</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">window</span>.<span class="variable">console</span> !== <span class="variable">undefined</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">console</span>.<span class="variable">time</span> !== <span class="variable">undefined</span>){
      <span class="variable">debug</span>.<span class="variable">time</span> = <span class="keyword">function</span> (<span class="keyword">label</span>){
        <span class="variable">console</span>.<span class="variable">time</span>(<span class="keyword">label</span>);
      }
      <span class="variable">debug</span>.<span class="variable">time</span>();
    } <span class="keyword">else</span> {
      <span class="variable">debug</span>.<span class="variable">time</span> = <span class="keyword">function</span>(){};
    }
  },
  <span class="variable">timeEnd</span>: <span class="keyword">function</span>(<span class="keyword">label</span>) {
    <span class="keyword">if</span>(<span class="variable">debug</span>.<span class="variable">on</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">window</span>.<span class="variable">console</span> !== <span class="variable">undefined</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">console</span>.<span class="variable">timeEnd</span> !== <span class="variable">undefined</span>){
      <span class="variable">debug</span>.<span class="variable">timeEnd</span> = <span class="keyword">function</span> (<span class="keyword">label</span>){
        <span class="variable">console</span>.<span class="variable">timeEnd</span>(<span class="keyword">label</span>);
      }
      <span class="variable">debug</span>.<span class="variable">timeEnd</span>();
    } <span class="keyword">else</span> {
      <span class="variable">debug</span>.<span class="variable">time</span> = <span class="keyword">function</span>(){};
    }
  }
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Loads json data on demand, supports preloading</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  preload_var variable name where preloaded data is</p></li><li><p><strong>param</strong>: <em>string</em>  url to get the data from if it's not preloaded</p></li><li><p><strong>param</strong>: <em>function</em>  success function to call when done</p></li><li><p><strong>param</strong>: <em>function</em>  error function to call when done</p></li><li><p><strong>param</strong>: <em>boolean</em>  fresh demand fresh data</p></li><li><p><strong>param</strong>: <em>object</em>  params to send to the server</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">loader</span>(<span class="variable">preload_var</span>, <span class="variable">url</span>, <span class="variable">success</span>, <span class="variable">error</span>, <span class="variable">fresh</span>, <span class="variable">params</span>){
  <span class="keyword">if</span>(<span class="variable">window</span>[<span class="variable">preload_var</span>] !== <span class="variable">undefined</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; !<span class="variable">fresh</span>){
    <span class="variable">success</span>(<span class="variable">window</span>[<span class="variable">preload_var</span>]);
  } <span class="keyword">else</span> {
    $.<span class="variable">ajax</span>({
      <span class="variable">url</span>: <span class="variable">url</span>,
      <span class="variable">type</span>: <span class="string">'GET'</span>,
      <span class="variable">data</span>: <span class="variable">params</span>,
      <span class="variable">success</span>: <span class="keyword">function</span>(<span class="variable">data</span>, <span class="variable">textStatus</span>, <span class="variable">jqXHR</span>){
        <span class="variable">success</span>(<span class="variable">data</span>, <span class="variable">textStatus</span>, <span class="variable">jqXHR</span>);
      },
      <span class="variable">error</span>: <span class="keyword">function</span>(<span class="variable">data</span>, <span class="variable">textStatus</span>, <span class="variable">errorThrown</span>){
        <span class="variable">error</span>(<span class="variable">data</span>, <span class="variable">textStatus</span>, <span class="variable">errorThrown</span>);
      },
      <span class="variable">dataType</span>: <span class="string">'json'</span>,
      <span class="variable">cache</span>: <span class="variable">false</span>
    });
  }
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Show a dialog with the submit and cancel buttons</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  html</p></li><li><p><strong>param</strong>: <em>string</em>  title</p></li><li><p><strong>param</strong>: <em>function</em>  submit</p></li><li><p><strong>param</strong>: <em>string</em>  submit_label optional</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">submit_cancel_dialog</span>(<span class="variable">html</span>, <span class="variable">title</span>, <span class="variable">submit</span>, <span class="variable">submit_label</span>){
  <span class="comment">//parameter parsing</span>
  <span class="variable">submit_label</span> = <span class="variable">submit_label</span> || <span class="string">'Submit'</span>;
  
  <span class="comment">//vars</span>
  <span class="keyword">var</span> <span class="variable">buttons</span>;
  
  <span class="comment">//setup</span>
  <span class="variable">buttons</span> = {};
  <span class="variable">buttons</span>[<span class="variable">submit_label</span>] = <span class="variable">submit</span>;
  <span class="variable">buttons</span>.<span class="class">Cancel</span> = <span class="keyword">function</span> () {
    $(<span class="this">this</span>).<span class="variable">dialog</span>(&<span class="variable">quot</span>;<span class="variable">close</span>&<span class="variable">quot</span>;);
  };
  
  <span class="comment">//open the dialog</span>
  $(<span class="variable">html</span>).<span class="variable">dialog</span>({
    <span class="variable">title</span>: <span class="variable">title</span>,
    <span class="variable">buttons</span>: <span class="variable">buttons</span>,
    <span class="variable">modal</span>:<span class="variable">true</span>
  });
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The main application namespaces
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">watedit</span> = {}, <span class="variable">field_manager</span> = {}, <span class="variable">entry_manager</span> = {};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Some default state information
 </p>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">edit_mode</span> = <span class="variable">false</span>;
<span class="variable">watedit</span>.<span class="variable">admin</span> = <span class="variable">false</span>;
<span class="variable">watedit</span>.<span class="class">LinkData</span> = {};
<span class="variable">watedit</span>.<span class="class">RevisionData</span> = {};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets the main data and draws the app</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  data to set</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">init</span> = <span class="keyword">function</span>(<span class="variable">data</span>) {
  <span class="variable">watedit</span>.<span class="class">LinkData</span> = <span class="variable">data</span>;
  <span class="variable">watedit</span>.<span class="variable">redraw</span>();
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Loads new data and calls watedit.init() with it</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>boolean</em>  fresh if the data should be fetched anew</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">load_data</span> = <span class="keyword">function</span>(<span class="variable">fresh</span>) {
  <span class="variable">debug</span>.<span class="variable">time</span>(<span class="string">'load'</span>);
  <span class="keyword">var</span> <span class="variable">params</span> = <span class="variable">false</span>;
  <span class="variable">params</span> = {<span class="string">'revision'</span>: <span class="variable">watedit</span>.<span class="class">RevisionData</span>.<span class="variable">current</span>};
  <span class="variable">loader</span>(
    <span class="string">'preload_current_data'</span>,
    <span class="string">'get_revision.php'</span>,
    <span class="keyword">function</span>(<span class="variable">data</span>){
      <span class="variable">watedit</span>.<span class="variable">init</span>(<span class="variable">data</span>);
      <span class="variable">debug</span>.<span class="variable">timeEnd</span>(<span class="string">'load'</span>);
    },
    <span class="keyword">function</span>(<span class="variable">jqXHR</span>, <span class="variable">textStatus</span>, <span class="variable">errorThrown</span>){
      <span class="variable">console</span>.<span class="variable">erorr</span>(<span class="variable">errorThrown</span>);
    },
    <span class="variable">fresh</span>,
    <span class="variable">params</span>
  );
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Loads revision data
 </p>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">load_revisions</span> = <span class="keyword">function</span>() {
  <span class="variable">loader</span>(
    <span class="string">'preload_revisions'</span>,
    <span class="string">'get_revisions.php'</span>,
    <span class="keyword">function</span>(<span class="variable">data</span>){
      <span class="variable">watedit</span>.<span class="class">RevisionData</span> = <span class="variable">data</span>;
    },
    <span class="keyword">function</span>(<span class="variable">jqXHR</span>, <span class="variable">textStatus</span>, <span class="variable">errorThrown</span>){
      <span class="variable">console</span>.<span class="variable">erorr</span>(<span class="variable">errorThrown</span>);
    }
  );
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Opens the dialog to log in the admin
 </p>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">login</span> = <span class="keyword">function</span>() {
  <span class="keyword">var</span> $<span class="variable">dialog</span> = $(<span class="string">'&lt;div&gt;'</span>), <span class="variable">view</span>;
  
  <span class="variable">view</span> = {
    <span class="variable">name</span>: <span class="string">'password'</span>,
    <span class="variable">password</span>: <span class="variable">true</span>
  };
  
  $<span class="variable">dialog</span>.<span class="variable">append</span>($.<span class="variable">mustache</span>(<span class="string">'input'</span>, <span class="variable">view</span>));
  
  <span class="variable">submit_cancel_dialog</span>($<span class="variable">dialog</span>, <span class="string">'Log in'</span>, <span class="keyword">function</span>() {
    <span class="keyword">var</span> $<span class="variable">dialog</span> = $(<span class="this">this</span>);
    
    $.<span class="variable">ajax</span>({
      <span class="variable">url</span>: <span class="string">'/login.php'</span>,
      <span class="variable">type</span>: <span class="string">'POST'</span>,
      <span class="variable">data</span>: {<span class="variable">password</span>: $(<span class="string">'input[name=&quot;password&quot;]'</span>, $<span class="variable">dialog</span>).<span class="variable">val</span>()},
      <span class="variable">success</span>: <span class="keyword">function</span> (<span class="variable">data</span>, <span class="variable">textStatus</span>, <span class="variable">jqXHR</span>) {
        <span class="keyword">if</span> (<span class="variable">data</span> === <span class="string">'1'</span>) {
          $.<span class="variable">jGrowl</span>(<span class="string">'Successfully logged in.'</span>);
          <span class="variable">watedit</span>.<span class="variable">admin</span> = <span class="variable">true</span>;
          <span class="variable">watedit</span>.<span class="variable">redraw</span>();
          $<span class="variable">dialog</span>.<span class="variable">dialog</span>(<span class="string">'close'</span>);
        } <span class="keyword">else</span> {
          $.<span class="variable">jGrowl</span>(<span class="variable">data</span>);
        }
      },
      <span class="variable">error</span>: <span class="keyword">function</span> () {
        $.<span class="variable">jGrowl</span>(<span class="string">'Failed to log in.'</span>);
      }
    });
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Logs out the admin
 </p>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">logout</span> = <span class="keyword">function</span>() {
  $.<span class="variable">get</span>(<span class="string">'logout.php'</span>, <span class="keyword">function</span>() {
    $.<span class="variable">jGrowl</span>(<span class="string">'You have been logged out.'</span>);
    <span class="variable">watedit</span>.<span class="variable">admin</span> = <span class="variable">false</span>;
    <span class="variable">watedit</span>.<span class="variable">redraw</span>();
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Opens a modal to let the user choose which revision to make active
 </p>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">choose_revisions</span> = <span class="keyword">function</span> () {
  
  <span class="keyword">function</span> <span class="variable">revisions_dialog</span>(<span class="variable">data</span>){
    <span class="keyword">var</span> <span class="variable">i</span>, <span class="variable">revision</span>, $<span class="variable">dialog</span> = $(<span class="string">'&lt;dialog&gt;'</span>), <span class="variable">view</span>, <span class="variable">current</span> = <span class="variable">watedit</span>.<span class="class">RevisionData</span>.<span class="variable">current</span>, <span class="variable">revisions</span> = <span class="variable">data</span>.<span class="variable">revisions</span>, <span class="variable">date</span>;
    
    <span class="keyword">for</span> (<span class="variable">i</span> <span class="keyword">in</span> <span class="variable">revisions</span>) {
      <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">prototype</span>.<span class="variable">hasOwnProperty</span>.<span class="variable">call</span>(<span class="variable">revisions</span>, <span class="variable">i</span>)) {
        <span class="variable">revision</span> = <span class="variable">revisions</span>[<span class="variable">i</span>];
        <span class="variable">date</span> = <span class="keyword">new</span> <span class="class">Date</span>();
        <span class="variable">date</span>.<span class="variable">setTime</span>( <span class="variable">revision</span>.<span class="variable">time</span>*<span class="number integer">1000</span> );
        <span class="variable">view</span> = {
          <span class="keyword">label</span>: <span class="variable">revision</span>.<span class="variable">description</span> + <span class="string">' -- '</span> + <span class="variable">date</span>.<span class="variable">toLocaleDateString</span>() + <span class="string">' '</span> + <span class="variable">date</span>.<span class="variable">toLocaleTimeString</span>() ,
          <span class="variable">checked</span>: <span class="variable">i</span> == <span class="variable">current</span>,
          <span class="variable">name</span>: <span class="string">'revision'</span>,
          <span class="variable">value</span>: <span class="variable">i</span>
        };
        $<span class="variable">dialog</span>.<span class="variable">append</span>($.<span class="variable">mustache</span>(<span class="string">'radio'</span>, <span class="variable">view</span>));
      }
    }

    <span class="variable">view</span> = {
      <span class="keyword">label</span>: <span class="string">'Change for everyone.'</span>,
      <span class="variable">checkbox</span>: <span class="variable">true</span>,
      <span class="variable">name</span>: <span class="string">'everyone'</span>
    };

    $<span class="variable">dialog</span>.<span class="variable">append</span>($.<span class="variable">mustache</span>(<span class="string">'input'</span>, <span class="variable">view</span>));
    
    <span class="variable">submit_cancel_dialog</span>($<span class="variable">dialog</span>, <span class="string">'Change active revision'</span>, <span class="keyword">function</span> () {
      $<span class="variable">dialog</span> = $(<span class="this">this</span>);
      <span class="keyword">var</span> <span class="variable">revision</span> = $(<span class="string">'input[name=&quot;revision&quot;]:checked'</span>, $<span class="variable">dialog</span>).<span class="variable">val</span>(),
          <span class="variable">everyone</span> = $(<span class="string">'input[name=&quot;everyone&quot;]'</span>, $<span class="variable">dialog</span>).<span class="variable">attr</span>(<span class="string">'checked'</span>);
      
      <span class="comment">//change active revision</span>
      <span class="variable">watedit</span>.<span class="class">RevisionData</span>.<span class="variable">current</span> = <span class="variable">revision</span>;
      
      <span class="keyword">if</span> (<span class="variable">everyone</span>) {
        $.<span class="variable">ajax</span>({
          <span class="variable">url</span>: <span class="string">'/set_current_revision.php'</span>,
          <span class="variable">type</span>: <span class="string">'POST'</span>,
          <span class="variable">data</span>: <span class="string">''</span>+<span class="variable">revision</span>,
          <span class="variable">success</span>: <span class="keyword">function</span> (<span class="variable">data</span>, <span class="variable">textStatus</span>, <span class="variable">jqXHR</span>) {
            <span class="keyword">if</span> (<span class="variable">data</span> === <span class="string">'1'</span>) {
              $.<span class="variable">jGrowl</span>(<span class="string">'Successfully changed the active revision.'</span>);
              <span class="variable">watedit</span>.<span class="variable">load_data</span>(<span class="variable">true</span>);
              $<span class="variable">dialog</span>.<span class="variable">dialog</span>(&<span class="variable">quot</span>;<span class="variable">close</span>&<span class="variable">quot</span>;);
            } <span class="keyword">else</span> {
              $.<span class="variable">jGrowl</span>(<span class="variable">data</span>);
            }
          },
          <span class="variable">error</span>: <span class="keyword">function</span> () {
            $.<span class="variable">jGrowl</span>(<span class="string">'Failed to change active revision.'</span>);
          }
        });
      } <span class="keyword">else</span> {
        <span class="variable">watedit</span>.<span class="variable">load_data</span>(<span class="variable">true</span>);
        $<span class="variable">dialog</span>.<span class="variable">dialog</span>(&<span class="variable">quot</span>;<span class="variable">close</span>&<span class="variable">quot</span>;);
      }
    });
  }
  
  <span class="variable">loader</span>(
    <span class="string">'preload_revisions'</span>,
    <span class="string">'get_revisions.php'</span>,
    <span class="keyword">function</span>(<span class="variable">data</span>){
      <span class="keyword">var</span> <span class="variable">save_current</span> = <span class="variable">watedit</span>.<span class="class">RevisionData</span>.<span class="variable">current</span>;
      <span class="variable">watedit</span>.<span class="class">RevisionData</span> = <span class="variable">data</span>;
      <span class="variable">watedit</span>.<span class="class">RevisionData</span>.<span class="variable">current</span> = <span class="variable">save_current</span>;
      <span class="variable">revisions_dialog</span>(<span class="variable">data</span>);
    },
    <span class="keyword">function</span>(<span class="variable">jqXHR</span>, <span class="variable">textStatus</span>, <span class="variable">errorThrown</span>){
      <span class="variable">console</span>.<span class="variable">erorr</span>(<span class="variable">errorThrown</span>);
    },
    <span class="variable">true</span>
  );
  
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Redraws everything
 </p>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">redraw</span> = <span class="keyword">function</span> () {
  <span class="variable">debug</span>.<span class="variable">time</span>(<span class="string">'redraw all'</span>);
  <span class="keyword">if</span> (<span class="variable">watedit</span>.<span class="variable">edit_mode</span>) {
    <span class="variable">field_manager</span>.<span class="variable">redraw</span>();
    $(<span class="string">'#submit-data, #new-item, #new-field, #refresh, #reload, #field-editor'</span>).<span class="variable">show</span>();
    <span class="keyword">if</span>(<span class="variable">watedit</span>.<span class="variable">admin</span>){
      $(<span class="string">'#revisions'</span>).<span class="variable">show</span>();
      $(<span class="string">'#login'</span>).<span class="variable">hide</span>();
      $(<span class="string">'#logout'</span>).<span class="variable">show</span>();
    } <span class="keyword">else</span> {
      $(<span class="string">'#revisions'</span>).<span class="variable">hide</span>();
      $(<span class="string">'#login'</span>).<span class="variable">show</span>();
      $(<span class="string">'#logout'</span>).<span class="variable">hide</span>();
    }
  } <span class="keyword">else</span> {
    $(<span class="string">'#submit-data, #new-item, #new-field, #refresh, #reload, #field-editor, #revisions, #login, #logout'</span>).<span class="variable">hide</span>();
  }
  <span class="variable">entry_manager</span>.<span class="variable">redraw</span>();
  <span class="variable">debug</span>.<span class="variable">timeEnd</span>(<span class="string">'redraw all'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Opens a dialog where the user enters a description and then submits a new revision
 </p>
</td>
<td class="code">
<pre><code><span class="variable">watedit</span>.<span class="variable">submit</span> = <span class="keyword">function</span>() {
  <span class="keyword">var</span> $<span class="variable">dialog</span>, $<span class="keyword">label</span>, $<span class="variable">input</span>;

  $<span class="variable">dialog</span> = $(<span class="string">'&lt;div&gt;'</span>);

  <span class="keyword">var</span> <span class="variable">view</span> = {
    <span class="keyword">label</span>: <span class="string">'Description'</span>,
    <span class="variable">name</span>: <span class="string">'description'</span>,
    <span class="variable">multiline</span>: <span class="variable">true</span>
  };
  $<span class="variable">dialog</span>.<span class="variable">append</span>($.<span class="variable">mustache</span>(<span class="string">'input'</span>, <span class="variable">view</span>));

  <span class="variable">submit_cancel_dialog</span>($<span class="variable">dialog</span>, <span class="string">'Submit a revision'</span>, 
    <span class="keyword">function</span> (){
      <span class="keyword">var</span> $<span class="variable">dialog</span> = $(<span class="this">this</span>),
          <span class="variable">description</span> = $(<span class="string">'textarea[name=&quot;description&quot;]'</span>, $<span class="variable">dialog</span>).<span class="variable">val</span>(),
          <span class="variable">data</span> = {};
          
      <span class="variable">data</span>.<span class="variable">data</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>;
      <span class="variable">data</span>.<span class="variable">meta</span> = {
        <span class="variable">description</span>: <span class="variable">description</span>
      };
      
      $.<span class="variable">ajax</span>({
        <span class="variable">url</span>: <span class="string">'/new_revision.php'</span>,
        <span class="variable">type</span>: <span class="string">'POST'</span>,
        <span class="variable">data</span>: <span class="class">JSON</span>.<span class="variable">stringify</span>(<span class="variable">data</span>),
        <span class="variable">success</span>: <span class="keyword">function</span> (<span class="variable">data</span>, <span class="variable">textStatus</span>, <span class="variable">jqXHR</span>) {
          <span class="keyword">if</span> (!<span class="variable">isNaN</span>(<span class="variable">data</span>)) {
            <span class="variable">watedit</span>.<span class="class">RevisionData</span>.<span class="variable">current</span> = <span class="variable">data</span>;
            $.<span class="variable">jGrowl</span>(<span class="string">'Successfully created new revision! It will be reviewed shortly.'</span>);
            $<span class="variable">dialog</span>.<span class="variable">dialog</span>(&<span class="variable">quot</span>;<span class="variable">close</span>&<span class="variable">quot</span>;);
          } <span class="keyword">else</span> {
            $.<span class="variable">jGrowl</span>(<span class="variable">data</span>);
          }
        },
        <span class="variable">error</span>: <span class="keyword">function</span> () {
          $.<span class="variable">jGrowl</span>(<span class="string">'Failed to create new revision.'</span>);
        }
      });
    });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Redraws all entries and inserts them into #item-editor
 </p>
</td>
<td class="code">
<pre><code><span class="variable">entry_manager</span>.<span class="variable">redraw</span> = <span class="keyword">function</span> () {
  <span class="keyword">var</span> $<span class="variable">ul</span> = $(<span class="string">'&lt;ul&gt;'</span>, {
    <span class="variable">id</span>: <span class="string">'links'</span>,
    <span class="string">'class'</span>: <span class="string">'grid'</span>
  }),
    <span class="variable">entry</span>,
    <span class="variable">editor</span> = $(<span class="string">'#item-editor'</span>),
    <span class="variable">entries</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>;

  <span class="keyword">for</span> (<span class="variable">entry</span> <span class="keyword">in</span> <span class="variable">entries</span>) {
    <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">prototype</span>.<span class="variable">hasOwnProperty</span>.<span class="variable">call</span>(<span class="variable">entries</span>, <span class="variable">entry</span>)) {
      <span class="comment">//the sorting function  needs to know the index, but is not given it</span>
      <span class="comment">//so we keep track of it ourselves</span>
      <span class="variable">entries</span>[<span class="variable">entry</span>].<span class="variable">sort_id</span> = <span class="variable">entry</span>;
      $<span class="variable">ul</span>.<span class="variable">append</span>(<span class="variable">entry_manager</span>.<span class="variable">build_entry</span>(<span class="variable">entry</span>));
    }
  }

  <span class="variable">editor</span>.<span class="variable">empty</span>();
  <span class="keyword">if</span> (<span class="variable">watedit</span>.<span class="variable">edit_mode</span>) {
    <span class="variable">editor</span>.<span class="variable">append</span>(<span class="string">'&lt;div class=&quot;big&quot;&gt;Entires&lt;/div&gt;'</span>);
  }
  <span class="variable">editor</span>.<span class="variable">append</span>($<span class="variable">ul</span>);

  <span class="keyword">if</span> (<span class="variable">watedit</span>.<span class="variable">edit_mode</span>) { <span class="comment">//sortable only in edit mode</span>
    $<span class="variable">ul</span>.<span class="variable">sortable</span>({
      <span class="variable">placeholder</span>: &<span class="variable">quot</span>;<span class="variable">item</span> <span class="variable">placeholder</span>&<span class="variable">quot</span>;,
      <span class="variable">update</span>: <span class="keyword">function</span> (<span class="variable">event</span>, <span class="variable">ui</span>) {
        <span class="keyword">var</span> <span class="variable">sort_order</span> = $(<span class="this">this</span>).<span class="variable">sortable</span>(<span class="string">'toArray'</span>);
        <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>.<span class="variable">sort</span>(<span class="keyword">function</span> (<span class="variable">a</span>, <span class="variable">b</span>) {
          <span class="keyword">return</span> <span class="variable">sort_order</span>.<span class="variable">indexOf</span>(<span class="string">'item_'</span> + <span class="variable">a</span>.<span class="variable">sort_id</span>) &<span class="variable">gt</span>; <span class="variable">sort_order</span>.<span class="variable">indexOf</span>(<span class="string">'item_'</span> + <span class="variable">b</span>.<span class="variable">sort_id</span>);
        });
        <span class="variable">entry_manager</span>.<span class="variable">redraw</span>();
      }
    });
    $<span class="variable">ul</span>.<span class="variable">disableSelection</span>();
  }
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Builds the entry's html and sets up the edit/delete events</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>number</em>  index of entry to build</p></li><li><p><strong>return</strong>: <em>object</em>  jquery dom element of the entry</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">entry_manager</span>.<span class="variable">build_entry</span> = <span class="keyword">function</span> (<span class="variable">index</span>) {
  <span class="keyword">var</span> $<span class="variable">a</span>, $<span class="variable">edit</span>, <span class="variable">property</span>, <span class="variable">_field</span>, $<span class="variable">field</span>, <span class="variable">entry</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>[<span class="variable">index</span>], <span class="variable">view</span>,
    $<span class="variable">entry</span> = $(<span class="string">'&lt;li&gt;'</span>, {
      <span class="string">'class'</span>: &<span class="variable">quot</span>;<span class="variable">item</span>&<span class="variable">quot</span>;,
      <span class="variable">id</span>: <span class="string">'item_'</span> + <span class="variable">index</span>
    }), <span class="variable">fields</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>, <span class="variable">field</span>, $<span class="keyword">delete</span>;

  <span class="comment">//go through each field and display its value</span>
  <span class="keyword">for</span> (<span class="variable">field</span> <span class="keyword">in</span> <span class="variable">fields</span>) {
    <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">prototype</span>.<span class="variable">hasOwnProperty</span>.<span class="variable">call</span>(<span class="variable">fields</span>, <span class="variable">field</span>)) {
      <span class="variable">_field</span> = <span class="variable">fields</span>[<span class="variable">field</span>];
      <span class="variable">property</span> = <span class="variable">entry</span>[<span class="variable">_field</span>.<span class="variable">name</span>];
      <span class="comment">//if this entry has a property coresponding to this field</span>
      <span class="keyword">if</span> (<span class="variable">property</span> !== <span class="variable">undefined</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">property</span>.<span class="variable">text</span> !== <span class="string">''</span>) {
        <span class="variable">view</span> = {
          <span class="string">'class'</span>: <span class="variable">_field</span>[<span class="string">'class'</span>],
          <span class="variable">link</span>: <span class="variable">property</span>.<span class="variable">url</span>,
          <span class="keyword">label</span>: <span class="variable">_field</span>.<span class="keyword">label</span>,
          <span class="variable">text</span>: <span class="variable">property</span>.<span class="variable">text</span>
        };
        $<span class="variable">entry</span>.<span class="variable">append</span>($.<span class="variable">mustache</span>(<span class="string">'entry-field'</span>, <span class="variable">view</span>));
      }
    }
  }
  <span class="keyword">if</span> (<span class="variable">watedit</span>.<span class="variable">edit_mode</span>) {
    <span class="comment">//edit button</span>
    $<span class="variable">edit</span> = $(<span class="string">'&lt;a&gt;'</span>, {
      <span class="string">'class'</span>: <span class="string">'faux-button'</span>
    });
    $<span class="variable">edit</span>.<span class="variable">text</span>(<span class="string">'Edit'</span>);
    $<span class="variable">edit</span>.<span class="variable">click</span>(<span class="keyword">function</span> () {
      <span class="variable">entry_manager</span>.<span class="variable">open_editor</span>(<span class="variable">index</span>);
    });
    $<span class="variable">entry</span>.<span class="variable">append</span>($<span class="variable">edit</span>);
    <span class="comment">//delete button</span>
    $<span class="keyword">delete</span> = $(<span class="string">'&lt;a&gt;'</span>, {
      <span class="string">'class'</span>: <span class="string">'faux-button'</span>
    });
    $<span class="keyword">delete</span>.<span class="variable">text</span>(<span class="string">'Delete'</span>);
    $<span class="keyword">delete</span>.<span class="variable">click</span>(<span class="keyword">function</span> () {
      <span class="keyword">if</span> (<span class="variable">confirm</span>(<span class="string">'Are you sure you want to delete this item?'</span>)) {
        <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>.<span class="variable">splice</span>(<span class="variable">index</span>, <span class="number integer">1</span>);
        <span class="variable">watedit</span>.<span class="variable">redraw</span>();
      }
    });
    $<span class="variable">entry</span>.<span class="variable">append</span>($<span class="keyword">delete</span>);
  }
  <span class="keyword">return</span> $<span class="variable">entry</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Open a modal to edit the entry with this index</p>

<p>Modifies watedit.LinkData and triggers redraw of entries</p>

<ul><li><strong>param</strong>: <em>index</em>
of entry to edit</li></ul>
</td>
<td class="code">
<pre><code><span class="variable">entry_manager</span>.<span class="variable">open_editor</span> = <span class="keyword">function</span> (<span class="variable">index</span>) {
  <span class="keyword">var</span> <span class="variable">_field</span>, <span class="variable">property</span>, <span class="variable">field</span>, $<span class="variable">field</span>, <span class="variable">view</span>, <span class="variable">title</span>,
    <span class="variable">entry</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>[<span class="variable">index</span>],
    <span class="variable">fields</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>,
    $<span class="variable">fields</span> = $(<span class="string">'&lt;div&gt;'</span>);
  
  <span class="keyword">for</span> (<span class="variable">field</span> <span class="keyword">in</span> <span class="variable">fields</span>) {
    <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">prototype</span>.<span class="variable">hasOwnProperty</span>.<span class="variable">call</span>(<span class="variable">fields</span>, <span class="variable">field</span>)) {
      <span class="variable">_field</span> = <span class="variable">fields</span>[<span class="variable">field</span>];
      <span class="variable">property</span> = <span class="variable">entry</span>[<span class="variable">_field</span>.<span class="variable">name</span>];
      <span class="variable">view</span> = {
        <span class="variable">val</span>: <span class="variable">property</span> ? <span class="variable">property</span>.<span class="variable">text</span> : <span class="string">''</span>,
        <span class="keyword">label</span>: <span class="variable">_field</span>.<span class="variable">name</span>,
        <span class="variable">purpose</span>: <span class="string">'text'</span>,
        <span class="variable">field</span>: <span class="variable">_field</span>.<span class="variable">name</span>,
        <span class="variable">multiline</span>: <span class="variable">_field</span>.<span class="variable">multiline</span>
      };

      <span class="comment">//text input</span>
      $<span class="variable">fields</span>.<span class="variable">append</span>($.<span class="variable">mustache</span>(<span class="string">'input'</span>, <span class="variable">view</span>));

      <span class="comment">//url input</span>
      <span class="keyword">if</span> (<span class="variable">_field</span>.<span class="variable">url</span>) {
        <span class="variable">view</span>.<span class="keyword">label</span> += <span class="string">' url'</span>;
        <span class="variable">view</span>.<span class="variable">val</span> = <span class="variable">property</span> ? <span class="variable">property</span>.<span class="variable">url</span> : <span class="string">''</span>;
        <span class="variable">view</span>.<span class="variable">purpose</span> = <span class="string">'url'</span>;
        $<span class="variable">fields</span>.<span class="variable">append</span>($.<span class="variable">mustache</span>(<span class="string">'input'</span>, <span class="variable">view</span>));
      }
    }
  }
  
  <span class="variable">title</span> = <span class="variable">entry</span>[<span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>[<span class="number integer">0</span>].<span class="variable">name</span>] ? <span class="variable">entry</span>[<span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>[<span class="number integer">0</span>].<span class="variable">name</span>].<span class="variable">text</span> : <span class="string">'Untitled'</span>;
  
  <span class="variable">submit_cancel_dialog</span>($<span class="variable">fields</span>, <span class="variable">title</span>, <span class="keyword">function</span>(){
    <span class="keyword">var</span> $<span class="variable">dialog</span> = $(<span class="this">this</span>),
        $<span class="variable">inputs</span> = $(<span class="string">'input,textarea'</span>, $<span class="variable">dialog</span>),
        $<span class="variable">input</span>, <span class="variable">purpose</span>, <span class="variable">field</span>, <span class="variable">val</span>, <span class="variable">n</span>, <span class="variable">length</span>;

    <span class="keyword">try</span>{
      <span class="comment">//get all the inputs and text areas</span>
      <span class="keyword">for</span> (<span class="variable">n</span> = <span class="number integer">0</span>, <span class="variable">length</span> = $<span class="variable">inputs</span>.<span class="variable">length</span>; <span class="variable">n</span> &<span class="variable">lt</span>; <span class="variable">length</span>; <span class="variable">n</span> += <span class="number integer">1</span>) {
        $<span class="variable">input</span> = $($<span class="variable">inputs</span>[<span class="variable">n</span>]); <span class="comment">//get the input element</span>
        <span class="variable">val</span> = $<span class="variable">input</span>.<span class="variable">val</span>(); <span class="comment">//new value to set</span>
        <span class="variable">field</span> = $<span class="variable">input</span>.<span class="variable">attr</span>(<span class="string">'field'</span>); <span class="comment">//field to edit</span>
        <span class="variable">purpose</span> = $<span class="variable">input</span>.<span class="variable">attr</span>(<span class="string">'purpose'</span>); <span class="comment">//text or url</span>
        <span class="comment">//create the field if it didn't exist but we are giving it a value</span>
        <span class="keyword">if</span> (<span class="variable">entry</span>[<span class="variable">field</span>] === <span class="variable">undefined</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">val</span> !== <span class="string">''</span>) {
          <span class="variable">entry</span>[<span class="variable">field</span>] = {};
        }

        <span class="comment">//set the value</span>
        <span class="keyword">if</span> (<span class="variable">entry</span>[<span class="variable">field</span>] !== <span class="variable">undefined</span>) {
          <span class="keyword">if</span> (<span class="variable">val</span> !== <span class="string">''</span>) {
            <span class="keyword">if</span>(<span class="variable">purpose</span> == <span class="string">'url'</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">val</span>.<span class="variable">substr</span>(<span class="number integer">0</span>,<span class="number integer">4</span>) != <span class="string">'http'</span>){
              <span class="keyword">throw</span> <span class="string">'Invalid URL'</span>;
            }
            <span class="variable">entry</span>[<span class="variable">field</span>][<span class="variable">purpose</span>] = <span class="variable">val</span>;
          } <span class="keyword">else</span> {
            <span class="keyword">delete</span> <span class="variable">entry</span>[<span class="variable">field</span>][<span class="variable">purpose</span>];
          }
        }
        <span class="comment">//remove empty object</span>
        <span class="keyword">if</span> ($.<span class="variable">isEmptyObject</span>(<span class="variable">entry</span>[<span class="variable">field</span>])) {
          <span class="keyword">delete</span> <span class="variable">entry</span>[<span class="variable">field</span>];
        }
      }
      <span class="variable">entry_manager</span>.<span class="variable">redraw</span>();
      $(<span class="this">this</span>).<span class="variable">dialog</span>(&<span class="variable">quot</span>;<span class="variable">close</span>&<span class="variable">quot</span>;);
    } <span class="keyword">catch</span> (<span class="variable">e</span>) {
      $.<span class="variable">jGrowl</span>(<span class="variable">e</span>.<span class="variable">toString</span>());
    }
  }, <span class="string">'Save'</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Redraw all fields</p>

<p>It places the new fields into #field-editor
 </p>
</td>
<td class="code">
<pre><code><span class="variable">field_manager</span>.<span class="variable">redraw</span> = <span class="keyword">function</span> () {
  <span class="comment">//safety first, frosh</span>
  <span class="keyword">if</span>(<span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span> === <span class="variable">undefined</span>){
    <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span> = [];
  }
  
  <span class="keyword">var</span> $<span class="variable">ul</span> = $(<span class="string">'&lt;ul&gt;'</span>, {
    <span class="variable">id</span>: <span class="string">'fields'</span>,
    <span class="string">'class'</span>: <span class="string">'grid'</span>
  }), <span class="variable">fields</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>, <span class="variable">field</span>;

  <span class="keyword">for</span> (<span class="variable">field</span> <span class="keyword">in</span> <span class="variable">fields</span>) {
    <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">prototype</span>.<span class="variable">hasOwnProperty</span>.<span class="variable">call</span>(<span class="variable">fields</span>, <span class="variable">field</span>)) {
      <span class="comment">//the sorting function  needs to know the index, but is not given it</span>
      <span class="comment">//so we keep track of it ourselves</span>
      <span class="variable">fields</span>[<span class="variable">field</span>].<span class="variable">sort_id</span> = <span class="variable">field</span>;
      $<span class="variable">ul</span>.<span class="variable">append</span>(<span class="variable">field_manager</span>.<span class="variable">build_field</span>(<span class="variable">field</span>));
    }
  }

  $(<span class="string">'#field-editor'</span>).<span class="variable">empty</span>().<span class="variable">append</span>(<span class="string">'&lt;div class=&quot;big&quot;&gt;Fields&lt;/div&gt;'</span>).<span class="variable">append</span>($<span class="variable">ul</span>);

  $<span class="variable">ul</span>.<span class="variable">sortable</span>({
    <span class="variable">placeholder</span>: &<span class="variable">quot</span>;<span class="variable">field</span> <span class="variable">placeholder</span>&<span class="variable">quot</span>;,
    <span class="variable">update</span>: <span class="keyword">function</span> (<span class="variable">event</span>, <span class="variable">ui</span>) {
      <span class="keyword">var</span> <span class="variable">sort_order</span> = $(<span class="this">this</span>).<span class="variable">sortable</span>(<span class="string">'toArray'</span>);
      <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>.<span class="variable">sort</span>(<span class="keyword">function</span> (<span class="variable">a</span>, <span class="variable">b</span>) {
        <span class="keyword">return</span> <span class="variable">sort_order</span>.<span class="variable">indexOf</span>(<span class="string">'field_'</span> + <span class="variable">a</span>.<span class="variable">sort_id</span>) &<span class="variable">gt</span>; <span class="variable">sort_order</span>.<span class="variable">indexOf</span>(<span class="string">'field_'</span> + <span class="variable">b</span>.<span class="variable">sort_id</span>);
      });
      <span class="variable">watedit</span>.<span class="variable">redraw</span>();
    }
  });
  $<span class="variable">ul</span>.<span class="variable">disableSelection</span>();
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Builds the html for a field and attaches actions to the edit/delete buttons</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>number</em>  index of the field to build</p></li><li><p><strong>return</strong>: <em>object</em>  jquery dom element of the field</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">field_manager</span>.<span class="variable">build_field</span> = <span class="keyword">function</span> (<span class="variable">index</span>) {
  <span class="keyword">var</span> $<span class="variable">li</span> = $(<span class="string">'&lt;li&gt;'</span>, {
    <span class="string">'class'</span>: &<span class="variable">quot</span>;<span class="variable">field</span>&<span class="variable">quot</span>;,
    <span class="variable">id</span>: <span class="string">'field_'</span> + <span class="variable">index</span>
  }), $<span class="variable">div</span>, <span class="variable">property</span>, $<span class="variable">title</span>, $<span class="variable">edit</span>, $<span class="keyword">delete</span>,
      <span class="variable">_field</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>[<span class="variable">index</span>];

  $<span class="variable">title</span> = $(<span class="string">'&lt;div&gt;'</span>, {
    <span class="string">'class'</span>: &<span class="variable">quot</span>;<span class="variable">name</span>&<span class="variable">quot</span>;
  });
  $<span class="variable">title</span>.<span class="variable">text</span>(<span class="variable">_field</span>.<span class="variable">name</span>);
  $<span class="variable">li</span>.<span class="variable">append</span>($<span class="variable">title</span>);
  <span class="keyword">for</span> (<span class="variable">property</span> <span class="keyword">in</span> <span class="variable">_field</span>) {
    <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">prototype</span>.<span class="variable">hasOwnProperty</span>.<span class="variable">call</span>(<span class="variable">_field</span>, <span class="variable">property</span>)) {
      $<span class="variable">div</span> = $(<span class="string">'&lt;div&gt;'</span>);
      <span class="keyword">if</span> (<span class="variable">property</span> !== <span class="string">'order'</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">property</span> !== <span class="string">'name'</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">property</span> !== <span class="string">'sort_id'</span>) {
        $<span class="variable">div</span>.<span class="variable">text</span>(<span class="variable">property</span> + <span class="string">': '</span> + <span class="variable">_field</span>[<span class="variable">property</span>]);
      }
      $<span class="variable">li</span>.<span class="variable">append</span>($<span class="variable">div</span>);
    }
  }

  <span class="comment">//edit button</span>
  $<span class="variable">edit</span> = $(<span class="string">'&lt;a&gt;'</span>, {
    <span class="string">'class'</span>: <span class="string">'faux-button'</span>
  });
  $<span class="variable">edit</span>.<span class="variable">text</span>(<span class="string">'Edit'</span>);
  $<span class="variable">edit</span>.<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">field_manager</span>.<span class="variable">open_editor</span>(<span class="variable">index</span>);
  });
  $<span class="variable">li</span>.<span class="variable">append</span>($<span class="variable">edit</span>);
  <span class="comment">//delete button</span>
  $<span class="keyword">delete</span> = $(<span class="string">'&lt;a&gt;'</span>, {
    <span class="string">'class'</span>: <span class="string">'faux-button'</span>
  });
  $<span class="keyword">delete</span>.<span class="variable">text</span>(<span class="string">'Delete'</span>);
  $<span class="keyword">delete</span>.<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="keyword">if</span> (<span class="variable">confirm</span>(<span class="string">'Are you sure you want to delete this field?'</span>)) {
      <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>.<span class="variable">splice</span>(<span class="variable">index</span>, <span class="number integer">1</span>);
      <span class="variable">watedit</span>.<span class="variable">redraw</span>();
    }
  });
  $<span class="variable">li</span>.<span class="variable">append</span>($<span class="keyword">delete</span>);
  <span class="keyword">return</span> $<span class="variable">li</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>This is a list of all properties a field may define.
Currently anything other than bool is a text value and bool is a 
checkbox which results in true/false when saved
 </p>
</td>
<td class="code">
<pre><code><span class="variable">field_manager</span>.<span class="variable">possible_properties</span> = {
  <span class="comment">//property name : property type</span>
  <span class="string">'name'</span>: <span class="string">'text'</span>,
  <span class="string">'class'</span>: <span class="string">'text'</span>,
  <span class="string">'label'</span>: <span class="string">'multiline'</span>,
  <span class="string">'multiline'</span>: <span class="string">'bool'</span>,
  <span class="string">'url'</span>: <span class="string">'bool'</span>
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Open a modal to edit the field with this index</p>

<p>Modifies watedit.LinkData and triggers redraw of everything</p>

<ul><li><strong>param</strong>: <em>index</em>
of field to edit</li></ul>
</td>
<td class="code">
<pre><code><span class="variable">field_manager</span>.<span class="variable">open_editor</span> = <span class="keyword">function</span> (<span class="variable">index</span>) {
  <span class="keyword">var</span> <span class="variable">property</span>, <span class="variable">prop_type</span>, <span class="variable">view</span>,
      <span class="variable">field</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>[<span class="variable">index</span>],
      $<span class="variable">properties</span> = $(<span class="string">'&lt;div&gt;'</span>);

  <span class="comment">//go through each property that a field can have</span>
  <span class="keyword">for</span> (<span class="variable">property</span> <span class="keyword">in</span> <span class="variable">field_manager</span>.<span class="variable">possible_properties</span>) {
    <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">prototype</span>.<span class="variable">hasOwnProperty</span>.<span class="variable">call</span>(<span class="variable">field_manager</span>.<span class="variable">possible_properties</span>, <span class="variable">property</span>)) {
      <span class="variable">prop_type</span> = <span class="variable">field_manager</span>.<span class="variable">possible_properties</span>[<span class="variable">property</span>];
      
      <span class="variable">view</span> = {
        <span class="variable">val</span>: <span class="variable">field</span>[<span class="variable">property</span>],
        <span class="keyword">label</span>: <span class="variable">property</span>,
        <span class="variable">name</span>: <span class="variable">property</span>,
        <span class="variable">checked</span>: <span class="variable">field</span>[<span class="variable">property</span>] === <span class="variable">true</span>,
        <span class="variable">checkbox</span>: <span class="variable">prop_type</span> === <span class="string">'bool'</span>,
        <span class="variable">multiline</span>: <span class="variable">prop_type</span> === <span class="string">'multiline'</span>
      };
      $<span class="variable">properties</span>.<span class="variable">append</span>($.<span class="variable">mustache</span>(<span class="string">'input'</span>, <span class="variable">view</span>));
    }
  }

  $<span class="variable">properties</span>.<span class="variable">dialog</span>({
    <span class="variable">title</span>: <span class="variable">field</span>.<span class="variable">name</span>,
    <span class="variable">modal</span>: <span class="variable">true</span>,
    <span class="variable">buttons</span>: {
      <span class="class">Save</span>: <span class="keyword">function</span> () {
        <span class="keyword">var</span> $<span class="variable">inputs</span> = $(<span class="string">'input,textarea'</span>, $<span class="variable">properties</span>), <span class="variable">n</span>,
            $<span class="variable">input</span>, <span class="variable">val</span>, <span class="variable">old_data</span>, <span class="variable">name</span>, <span class="variable">entry</span>, <span class="variable">length</span>,
            <span class="variable">old_name</span> = <span class="variable">field</span>.<span class="variable">name</span>;

        <span class="comment">//get all the inputs and text areas</span>
        <span class="keyword">for</span> (<span class="variable">n</span> = <span class="number integer">0</span>, <span class="variable">length</span> = $<span class="variable">inputs</span>.<span class="variable">length</span>; <span class="variable">n</span> &<span class="variable">lt</span>; <span class="variable">length</span>; <span class="variable">n</span> += <span class="number integer">1</span>) {
          $<span class="variable">input</span> = $($<span class="variable">inputs</span>[<span class="variable">n</span>]); <span class="comment">//get the input element</span>
          <span class="variable">val</span> = $<span class="variable">input</span>.<span class="variable">val</span>(); <span class="comment">//new value to set</span>
          <span class="variable">name</span> = $<span class="variable">input</span>.<span class="variable">attr</span>(<span class="string">'name'</span>); <span class="comment">//name of the property to edit</span>
          <span class="comment">//we have to not lose the relationship if we change the name!</span>
          <span class="keyword">if</span> (<span class="variable">name</span> === <span class="string">'name'</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">val</span> !== <span class="variable">old_name</span>) {
            <span class="keyword">for</span> (<span class="variable">entry</span> <span class="keyword">in</span> <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>) {
              <span class="keyword">if</span> (<span class="class">Object</span>.<span class="variable">prototype</span>.<span class="variable">hasOwnProperty</span>.<span class="variable">call</span>(<span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>, <span class="variable">entry</span>)) {
                <span class="variable">old_data</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>[<span class="variable">entry</span>][<span class="variable">old_name</span>];
                <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>[<span class="variable">entry</span>][<span class="variable">val</span>] = <span class="variable">old_data</span>;
              }
            }
          }

          <span class="comment">//create the property if it didn't exist but we are giving it a value</span>
          <span class="keyword">if</span> ($<span class="variable">input</span>.<span class="variable">attr</span>(<span class="string">'type'</span>) === <span class="string">'checkbox'</span>) {
            <span class="keyword">if</span> ($<span class="variable">input</span>.<span class="variable">attr</span>(<span class="string">'checked'</span>)) {
              <span class="variable">field</span>[<span class="variable">name</span>] = <span class="variable">true</span>;
            } <span class="keyword">else</span> {
              <span class="keyword">delete</span> <span class="variable">field</span>[<span class="variable">name</span>];
            }
          } <span class="keyword">else</span> {
            <span class="keyword">if</span> (<span class="variable">val</span> !== <span class="string">''</span>) {
              <span class="variable">field</span>[<span class="variable">name</span>] = <span class="variable">val</span>;
            } <span class="keyword">else</span> {
              <span class="keyword">delete</span> <span class="variable">field</span>[<span class="variable">name</span>];
            }
          }
        }
        <span class="variable">watedit</span>.<span class="variable">redraw</span>();
        $(<span class="this">this</span>).<span class="variable">dialog</span>(&<span class="variable">quot</span>;<span class="variable">close</span>&<span class="variable">quot</span>;);
      },
      <span class="class">Cancel</span>: <span class="keyword">function</span> () {
        $(<span class="this">this</span>).<span class="variable">dialog</span>(&<span class="variable">quot</span>;<span class="variable">close</span>&<span class="variable">quot</span>;);
      }
    }
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Initializes all the click actions on the buttons.
 </p>
</td>
<td class="code">
<pre><code>$(<span class="variable">document</span>).<span class="variable">ready</span>(<span class="keyword">function</span> () {
  
  <span class="variable">debug</span>.<span class="variable">time</span>(<span class="string">'start up'</span>);
  
  <span class="comment">//set up event handlers for buttons</span>
  $(<span class="string">'#revisions'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">watedit</span>.<span class="variable">choose_revisions</span>();
  });
  
  $(<span class="string">'#login'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">watedit</span>.<span class="variable">login</span>();
  });
  
  $(<span class="string">'#logout'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">watedit</span>.<span class="variable">logout</span>();
  });
  
  $(<span class="string">'#submit-data'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">watedit</span>.<span class="variable">submit</span>();
  });

  $(<span class="string">'#new-item'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="keyword">var</span> <span class="variable">new_item_data</span> = {};
    <span class="comment">//first thing is title amirite?</span>
    <span class="variable">new_item_data</span>[<span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>[<span class="number integer">0</span>].<span class="variable">name</span>] = {
      <span class="string">'text'</span>: <span class="string">'New Item'</span>
    };
    <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span> = <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span> || [];
    <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>.<span class="variable">push</span>(<span class="variable">new_item_data</span>);
    <span class="variable">entry_manager</span>.<span class="variable">redraw</span>();
    <span class="variable">entry_manager</span>.<span class="variable">open_editor</span>(<span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">entries</span>.<span class="variable">length</span> - <span class="number integer">1</span>);
  });

  $(<span class="string">'#new-field'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>.<span class="variable">push</span>({
      <span class="string">'name'</span>: <span class="string">'New Field'</span>
    });
    <span class="variable">field_manager</span>.<span class="variable">redraw</span>();
    <span class="variable">field_manager</span>.<span class="variable">open_editor</span>(<span class="variable">watedit</span>.<span class="class">LinkData</span>.<span class="variable">fields</span>.<span class="variable">length</span> - <span class="number integer">1</span>);
  });

  $(<span class="string">'#refresh'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">watedit</span>.<span class="variable">redraw</span>();
  });

  $(<span class="string">'#reload'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">watedit</span>.<span class="variable">load_data</span>(<span class="variable">true</span>);
  });
  $(<span class="string">'#editor'</span>).<span class="variable">click</span>(<span class="keyword">function</span> () {
    <span class="variable">watedit</span>.<span class="variable">edit_mode</span> = <span class="variable">watedit</span>.<span class="variable">edit_mode</span> ? <span class="variable">false</span> : <span class="variable">true</span>;
    <span class="variable">watedit</span>.<span class="variable">redraw</span>();
  });
  
  <span class="variable">watedit</span>.<span class="variable">load_data</span>(<span class="variable">false</span>);
  <span class="variable">watedit</span>.<span class="variable">load_revisions</span>();
});
</code></pre>
</td>
</tr>	</body>
</html></tbody></table>